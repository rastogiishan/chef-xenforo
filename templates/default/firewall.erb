iptables_start() {
  # no IP spoofing
  if [ -e /proc/sys/net/ipv4/conf/all/rp_filter ] ; then
      for i in /proc/sys/net/ipv4/conf/*/rp_filter; do
          echo 1 > $i
      done
  fi

  # SYN flooding protection
  if [ -e /proc/sys/net/ipv4/tcp_syncookies ] ; then
      echo 1 > /proc/sys/net/ipv4/tcp_syncookies
  fi

  # Disable source routed packets
  for i in /proc/sys/net/ipv4/conf/*/accept_source_route ; do
      echo 0 > $i
  done

  # Init
  /sbin/iptables -F
  /sbin/iptables -X
  /sbin/iptables -P INPUT DROP
  /sbin/iptables -P FORWARD DROP
  /sbin/iptables -P OUTPUT ACCEPT

  # Permit localhost
  /sbin/iptables -A INPUT -s 127.0.0.0/8 -j ACCEPT

  # Drop invalid packets immediately
  /sbin/iptables -A INPUT   -m state --state INVALID -j DROP
  #/sbin/iptables -A FORWARD -m state --state INVALID -j DROP
  /sbin/iptables -A OUTPUT  -m state --state INVALID -j DROP

  # Drop bogus TCP packets
  /sbin/iptables -A INPUT -p tcp -m tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
  /sbin/iptables -A INPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j DROP

  # RFC 1918 (allow ssh from internal)
  /sbin/iptables -A INPUT -p tcp -d 10.0.0.0/8 --dport 22 -j ACCEPT
  /sbin/iptables -A INPUT -p tcp -d 172.16.0.0/12 --dport 22 -j ACCEPT
  /sbin/iptables -A INPUT -p tcp -d 192.168.0.0/24 --dport 22 -j ACCEPT

  # Permit some icmp
  /sbin/iptables -A INPUT -p icmp -m icmp --icmp-type address-mask-request -j DROP
  /sbin/iptables -A INPUT -p icmp -m icmp --icmp-type timestamp-request -j DROP
  /sbin/iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
  /sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
  /sbin/iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT
  /sbin/iptables -A INPUT -p icmp --icmp-type source-quench -j ACCEPT
  /sbin/iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT
  /sbin/iptables -A INPUT -p icmp --icmp-type parameter-problem -j ACCEPT

  # Allow established connections
  /sbin/iptables -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -A INPUT -p tcp --dport 1024:65535 -j ACCEPT
  /sbin/iptables -A INPUT -p udp --dport 1024:65535 -j ACCEPT

  <% @ports.each do |port| %>
  /sbin/iptables -A INPUT -p tcp --dport <%= port %> -j ACCEPT
  <% end %>
}

iptables_stop() {
  /sbin/iptables -F
  /sbin/iptables -X
  /sbin/iptables -P INPUT ACCEPT
  /sbin/iptables -P FORWARD ACCEPT
  /sbin/iptables -P OUTPUT ACCEPT
}

iptables_restart() {
  iptable_restart
}

case "$1" in
'start')
  iptables_start
  ;;
'stop')
  iptables_stop
  ;;
'restart')
  iptables_restart
  ;;
*)
  echo "usage $0 start|stop|restart"
esac
